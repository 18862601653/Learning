# ping

## ping的基本过程
假设有A、B、C、D四台主机，一台路由RA，子网掩码255.255.255.0，默认路由192.168.0.1
- A：192.168.0.4
- B：192.168.0.5
- C：192.168.0.6
- D：192.168.1.4

### 在同一网段内
当在主机A上“ping 192.168.0.5”后，
- ping命令会构建一个固定格式的ICMP请求数据包
- 由ICMP协议将这个数据包连同IP地址“192.168.0.5”一起交给IP层协议
- IP层协议将以地址“192.168.0.5”作为目标地址，本机的IP地址作为源地址，加上一些其他的控制信息，构建一个IP数据包，并想办法得到192.168.0.5的MAC地址（物理地址，数据链路层协议构建数据链路层数据------帧所必须的），以便交给数据链路层构建一个数据帧。IP层协议通过机器B的IP地址与自己的子网掩码，发现其根自己属于同一网段，就直接在本网段内找B的MAC地址，如果A和B之前有过通信，在A的ARP缓存表应该有B的IP与其MAC地址之间的映射关系，如果没有，就发一个ARP请求广播，得到B的MAC地址，一并交给数据链路层。然后数据链路层构建一个数据帧，目的地址是IP层传来的MAC地址，源地址是本机的MAC地址，外加一些控制信息，依据以太网的介质访问规则，将它们传送出去。
- 主机B在受到这个数据帧之后，先检查它的目的地址，并与本机的物理地址比对，如果相符就接收，否则丢弃。接收后检查该数据帧，将IP数据包从帧中提取出来，交给本机的IP层协议。同样IP层检查后，将有用的信息提取后，交给ICMP协议，ICMP协议处理后，马上构建一个ICMP应答包，发送给主机A。
### 不在同一网段内
当在主机A上“ping 192.168.1.4”后，开始和在同一网段内一样，当到了获取D的MAC地址时，IP协议通过计算发现，D与自己不在同一网段内，于是直接交给路由器处理，即将路由器的MAC取过来，对于如何获取路由器的MAC，方法同上（现在ARP缓存表中找，找不到就ARP广播）。路由器得到这个数据帧之后，再跟主机D联系，如果找不到，就给主机A返回一个超时的信息。
## ping的返回信息
### Request timed out
出现这个提示信息的情况：
- 对方已关机，或者在网络上根本没有这个地址
- 对方与自己不在同一个网段内，通过路由也无法找到对方，但有时对方是确实存在的，虽然对方不存在也返回超时信息
- 对方确实存在，但设置了ICMP数据包过滤（比如防火墙设置）

判断对方是否存在：

使用带参数-a的ping命令探测对方，如果能得到对方的NETBIOS名称，则说明对方是存在的，有防火墙设置，如果得不到，那么说明对方不存在或关机或不在同一个网段。
- 错误设置IP地址

正常情况下，一个主机应该有一个网卡，一个IP地址，或多个网卡，多个IP地址（这些地址一定要处于不同的IP子网）。但如果一个电脑的“拨号网络适配器”（相当于一块软网卡）的TCP/IP设置中，设置了一个与网卡IP地址处于同一子网的IP地址，这样在IP层协议看来，这台主机就有两个不同的接口处于同一网段。当从这台主机ping其他主机的时候，会存在以下问题：
- 主机不知道要将数据包发到哪个网络接口，因为有两个网络接口都连接在同一网段。
- 主机不知道将哪个地址作为数据包的源地址，因此从这台主机去ping其他机器，IP层协议会无法处理，超时后，ping就会发出一个“超时无应答”的错误信息提示。但从其他主机ping这台主机时，请求包从特定的网卡来，ICMP只需简单地将目的地址、源地址互换，并更改一些标记即可，ICMP应答包能顺利发出，其他主机也就能ping通这台主机了。

### Destination host unreachable
- 对方与自己不在同一网段内，而自己又没有设置默认的路由
- 网线出了故障

Request timed out与Destination host unreachable的区别：

如果所经过的路由器的路由表中具有到达目标的路由，而目标因为其他原因不可达，这时候会出现timed out，而如果路由表中连到达目标的路由都没有，则会出现Destination host unreachable。

### Bad IP address
- 没有连接到DNS服务器，所以无法解析这个IP地址
- IP地址不存在

### Source quench received
很少见，表示对方或中途的服务器繁忙无法回应

### Unknown host
不知名主机，远程主机的名字不能由域名服务器(DNS)转换成IP地址，故障原因可能是域名服务器有故障，或者其名字不正确，或者网络管理员的系统与远程主机之间的通信信路有故障。

### No answer
无响应，说明本地系统有一条通向中心主机的路由，但却接收不到它发给中心主机的任何信息，故障原因：
- 中心主机没有工作
- 本地或中心主机网络配置不正确
- 本地或中心的路由器没有工作
- 通信线路有故障
- 中心主机存在路由选择问题

### ping 127.0.0.1
如果本地循环地址无法ping通，说明本地机TCP/IP协议不能正常工作

### No route to host
网卡工作不正常

### transmit failed，error code：10043
网卡驱动不正常

### unknown host name
DNS配置不正确。

## 参考
[1] https://blog.csdn.net/fd8559350/article/details/52135571


