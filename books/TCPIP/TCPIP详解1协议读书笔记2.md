# TCPIP详解1协议读书笔记2
## 四、ARP
当一台主机把以太网数据帧发送到位于同一局域网上的另一台主机时，是根据48bit的以太网地址来确定目的接口的。设备驱动程序从不检查IP数据报中的目的IP地址。  
地址解析为这两种不同的地址形式提供映射：32bit的IP地址和数据链路层使用的任何类型的地址。  
![地址解析协议：ARP和RARP](https://github.com/Balabalabalala/Learning/blob/master/images/tcpip/2018-04-19_162353.png)  

ARP为IP地址到对应的硬件地址之间提供动态映射（自动完成，无需应用程序用户或系统管理员关心），RARP被没有磁盘驱动器的系统使用（需要系统管理员手工设置）。  
### 示例
当敲入以下命令时：
```
ftp 主机名
```
都会执行以下步骤：  
- 应用程序FTP客户端调用函数gethostbyname(3)把主机名转换成32bit的IP地址，这个函数在DNS（域名系统）中称作解析器，这个转换过程或者使用DNS，或者在较小网络中使用一个静态的主机文件（/etc/hosts). 
- FTP客户端请求TCP用得到的IP地址建立连接。  
- TCP发送一个连接请求分段到远端的主机，即用上述IP地址发送一份IP数据报。  
- 如果目的主机在本地网络上（如以太网、令牌环网或点对点链接的另一端），那么IP数据报可以直接送到目的主机上。如果目的主机在一个远程网络上，那就通过IP选路函数来确定位于本地网络上的下一站路由器地址，并让它转发IP数据报。这两种情况下，IP数据报都是被送到位于本地网络上的一台主机或路由器。  
- 假定是一个以太网，那么发送端主机必须把32bit的IP地址变换成48bit的以太网地址。从逻辑Internet地址到对应的物理硬件地址需要进行翻译，这就是ARP的功能，ARP本来是用于广播网络的，有许多主机或路由器连在同一个网络上。  
- ARP发送一份称作ARP请求的以太网数据帧给以太网上的每个主机，这个过程称作广播。ARP请求数据帧中包含目的主机的IP地址，意思是“如果你是这个IP地址的拥有者，请回答你的硬件地址”  
- 目的主机的ARP层收到这份广播报文后，识别出这是发送端在询问它的IP地址，于是发送一个ARP应答。这个ARP应答包含IP地址及对应的硬件地址。  
- 受到ARP应答后，使ARP进行请求-应答交换的IP数据报现在就可以传送了。  
- 发送IP数据报到目的主机。  
![当用户输入命令"ftp 主机名"时ARP的操作](https://github.com/Balabalabalala/Learning/blob/master/images/tcpip/2018-04-19_164306.png)  

网络接口有一个硬件地址（48bit的值，标识不同的以太网或令牌环网络接口），在硬件层次上进行的数据帧交换必须有正确的接口地址，但是TCP/IP有自己的地址：32bit的IP地址。知道主机的IP地址并不能让内核发送一帧数据给主机，内核（如以太网驱动程序）必须知道目的端的硬件地址才能发送数据。ARP的功能是在32bit的IP地址和采用不同网络技术的硬件地址之间提供动态映射。  
点对点链路不使用ARP，当设置这些链路时（一般在引导过程进行），必须告知内核链路每一端的IP地址，不涉及以太网地址这样的硬件地址。  
ARP高效运行的关键是每个主机上都有一个ARP高速缓存，这个高速缓存存放了最近Internet地址到硬件地址之间的映射记录。高速缓存中每一项的生存时间一般为20分钟，起始时间从被创建时开始算起。  
```
arp -a
arp检查arp高速缓存，-a显示告诉缓存中所有的内容。
```
48bit的以太网地址用6个十六进制数表示，中间以冒号隔开。  

ARP可用于其他类型的网络，可以解析IP地址以外的地址。  

![用于以太网的ARP请求或应答分组格式](https://github.com/Balabalabalala/Learning/blob/master/images/tcpip/2018-04-19_175840.png)

用于以太网的ARP请求或应答分组格式：  
- 前两个字段是以太网的源地址和目的地址。目的地址为全1的特殊地址是广播地址，电缆上所有以太网接口都有接收广播的数据帧。  
- 两个字节长的以太网帧类型表示后面数据的类型，对于ARP请求或应答来说，该字段的值为0x0806.  
- 硬件和协议用来描述ARP分组中的各个字段。如，一个ARP请求分组询问协议地址（这里指IP地址）对应的硬件地址（这里指以太网地址）。硬件类型字段表示硬件地址的类型，值为1表示以太网地址，协议类型字段表示要映射的协议地址类型，值为0x0800表示IP地址。它的值与包含IP数据报的以太网数据帧中的类型字段值相同。  
- 硬件地址长度和协议地址长度都是1字节的字段，分别指硬件地址和协议地址的长度，以字节为单位，对于以太网上IP地址的ARP请求或应答来说，它们的值分别是6和4.  
- 操作字段指出四种操作类型，它们是ARP请求（1），ARP应答（2），RARP请求（3），RARP应答（4）。这个字段是必需的，因为ARP请求和ARP应答的帧类型字段值是相同的。  
- 最后四个字段是发送端的硬件地址（本例中是以太网地址）、 发送端的协议地址（IP地址）、 目的端的硬件地址和目的端的协议地址。在以太网的数据帧报头中和ARP请求数据帧中都有发送端的硬件地址。  
对于一个ARP请求来说，除了目的端硬件地址外的所有其他的字段都有填充值，当系统收到一份目的端为本机的ARP请求报文后，它就把硬件地址填进去，然后用两个目的端地址分别替换两个发送端地址，并把操作字段置为2，最后发送回去。  

### tcpdump
tcpdump通过将网络接口卡设置为混杂模式来截获经过网络接口的每一个分组。正常情况下，用于诸如以太网媒体的接口卡指截获送往特定接口地址或广播地址的链路层的帧。  
底层的操作系统必须允许将一个接口设置成混杂模式，并且允许一个用户进程截获帧。  
BSD分组过滤器BPF（BSD Packet Filter），tcpdump用它来截获和过滤来自一个被置为混杂模式的网络接口卡的分组。BFP也可以工作在点对点的链路上，如SLIP，不需要什么特别的处理就可以截获所有通过接口的分组，BPF还可以工作在环回接口上。  
![BSD分组过滤器](https://github.com/Balabalabalala/Learning/blob/master/images/tcpip/2018-04-19_194310.png)  

BPF将以太网设备驱动程序设置为混杂模式，然后从驱动程序那里接收每一个收到的分组和传输的分组。这些分组要通过一个用户指明的过滤器，使得只有那些用户进程感兴趣的分组才会传递给用户进程。  
多个进程可以同时监视一个接口，每个进程指明一个自己的过滤器。  
tcpdump的过滤器可以由用户在命令行指明，而rarpd总是使用只截获RARP请求的过滤器。  
BPF的每个用户除了指明一个过滤器外，还指明一个超时定时器的值，因为网络的数据传输率可以很容易地超过CPU的处理能力，而且一个用户进程从内核中只读小块数据的代价昂贵，所以BPF尝试将多个帧装载进一个读缓存，只有缓存满了或者用户指明的超时到期才将读缓存保存的帧返回。tcpdump将超时定时器置为1秒，因为它一般从BPF收到很多数据，而RARP守护进程收到的帧很少，所以rarpd将超时置为0（即收到一个帧就返回）。  

用户指明的过滤器告诉BPF用户进程对什么帧感兴趣，过滤器是对一个假想机器的一组指令。这些指令被内核中的BPF过滤器解释，在内核中过滤，而不在用户进程中，减少了必须从内核传递到用户进程的数据量。RARP守护进程总是使用绑定在程序里的、同样的过滤程序。tcpdump在每次运行时，让用户在命令行指明一个过滤表达式。tcpdump将用户指明的表达式转换为相应的BPF的指令序列。  
```
tcpdump tcp port 25
只打印源端口和目的端口为25的TCP报文段
tcpdump 'icmp [0] != 8 and icmp[0] !=0'
只打印不是回送请求和回送应答的ICMP报文（非ping的分组），ICMP报文第一个字节8表示回送请求，0表示回送应答。用引号括起来是为了防止Unix外壳程序解释特殊字符。  
```

SunOS 4.1.x提供了一个STREAMS伪设备驱动程序，称为网络接口分接头或NIT（包含了流设备驱动程序的其他细节）。NIT类似于BSD分组过滤器，但在功能上没有BSD强大，效率也没有BSD高。BPF可以截获网络接口收到的和传送的分组，NIT只能截获接口收到的分组。tcpdump与NIT结合意味着只能看到由网络中其他主机发送来的分组，而不能看到自己主机发送的分组。
![SunOS的网络接口分接头](https://github.com/Balabalabalala/Learning/blob/master/images/tcpip/2018-04-19_225515.png)

当设备/dev/nit被打开时，流驱动程序nit_if就会被打开。因为NIT是使用流来构造的，所以处理模块可以放在nit_if驱动程序之上。tcpdump将模块nit_buf放在STREAM之上，这个模块将多个网络帧聚集在一个读缓存中，允许用户进程指明一个超时的值。RARP守护进程没有把这个模块放在它的流之上，因为它只处理了一小部分分组。用户指明的过滤由流模块nit_pf处理，这个模块被RARP守护进程所用，但没有被tcpdump使用。在SunOS操作系统中，tcpdump代之以在用户进程中完成自己的过滤操作。因为nit_pf使用的假想机器的指令与BPF所支持的指令不同，也就意味着当用户对tcpdump指明了一个过滤表达式时，与BPF相比，使用NIT就会有更多的数据在内核与用户进程之间交换。   

SVR4支持数据链路提供者接口DLPI（Data Link Provider Interface），是OSI数据链路服务定义的一个流实现。向tcpdump的网络监视程序必须使用DLPI来直接访问数据链路设备驱动程序。  




