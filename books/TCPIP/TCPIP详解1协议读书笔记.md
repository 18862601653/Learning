# TCP/IP详解卷1：协议读书笔记
## 一、概述
### 1.1分层
TCP/IP通常被认为是一个四层协议系统：

![TCP/IP协议族的四个层次](https://github.com/18862601653/Learning/blob/master/images/tcpip/2018-04-10_093055.png)

每一层负责不同的功能：
- 链路层，也称作数据链路层或网络接口层，通常包括操作系统中的设备驱动程序和计算机中对应的网络接口卡。它们一起处理与电缆（或其他任何传输媒介）的物理接口细节。
- 网络层，也称作互联网层，处理分组在网络中的活动，如分组的选路。

  在TCP/IP协议族中，网络层协议包括IP协议（网际协议），ICMP协议（Internet互联网控制报文协议）以及IGMP协议（Internet组管理协议）。

- 运输层，主要为两台主机上的应用程序提供端到端的通信。

  在TCP/IP协议族中，有两个互不相同的传输协议：TCP（传输控制协议）和UDP（用户数据报协议）。

  TCP为两台主机提供高可靠性的数据通信，它所做的工作包括把应用程序交给它的数据分成合适的小块交给下面的网络层，确认接收到的分组，设置发送最后确认分组的超时时钟等。由于运输层提供了高可靠性的端到端的通信，因此应用层可以忽略所有这些细节。

  UDP为应用层提供一种非常简单的服务。它只是把称作数据报的分组从一台主机发送到另一台主机，但并不保证该数据报能到达另一端。任何必需的可靠性必须由应用层来提供。

- 应用层，负责处理特定的应用程序细节。

  几乎各种不同的TCP/IP实现都会提供以下这些通用的应用程序：

  Telnet远程登录、FTP文件传输协议、SMTP简单邮件传送协议、SNMP简单网络管理协议

下面以一个局域网（LAN）中两台主机都运行FTP协议为例，列出该过程涉及的所有协议。
![局域网上运行FTP的两台主机](https://github.com/Balabalabalala/Learning/blob/master/images/tcpip/2018-04-10_122007.png)

值得注意的是：
- 大多数的网络应用程序都被设计成客户-服务器模式，服务器为客户提供某种服务，本例中是访问服务器所在主机上的文件。在远程登录应用层程序Telnet中，为客户提供的服务是登录到服务器主机上。
- 在同一层上，双方都有对应的一个或多个协议进行通信
- 应用程序通常是一个用户进程，下三层一般在（操作系统）内核中执行。这不是必须的，但通常都是这样处理。
- 应用层关心的是应用程序的细节，而不是数据在网络中的传输活动；下三层对应用一无所知，但它们要处理所有的通信细节。

单个计算机构成的孤岛没有意义，所以将这些计算机组在一起形成网络，但是由单个网络构成的新的更大的岛屿也没有意义，所以将多个网络连接在一起形成互联网。而所谓的互联网就是一组通过相同协议族互连在一起的网络。构建互联网最简单的方法就是把两个或多个网络通过路由器进行连接。路由器的好处是为不同的物理网络提供连接：以太网、令牌环网、点对点的链接和FDDI（光纤分布式数据接口）等。

令牌环网（Token-ring network），常用于IBM系统中，在这种网络中，有一种专门的帧称作“令牌”，在环路上持续地传输来确定一个结点何时可以发送包。

为什么要将网络层和运输层进行划分？
  - 划分端系统和中间系统：应用层和运输层使用端到端协议，只有端系统需要这两层协议，但是网络层提供的是逐跳协议，两个端系统和每个中间系统都要使用它。
  - 运输层和网络层负责不同的功能：网络层IP提供的是一种不可靠的服务，它只是尽可能快地将分组从源结点送到目的结点，而不提供任何可靠性保证。TCP在不可靠的IP层上提供了一个可靠的运输层，为了提供这种可靠的服务，TCP采用了超时重传、发送和接收端的确认分组等机制。

互联网的目的之一是在应用程序中隐藏所有的物理细节。

除了路由器以外，网桥也可以用来连接网络，网桥是在链路层上对网络进行互连，而路由器是在网络层上对网络进行互连。网桥使得多个局域网（LAN）组合在一起，这对上层来说就好像是一个局域网。TCP/IP倾向于使用路由器而不是网桥连接网路。

## 1.2 TCP/IP的分层

![TCP/IP协议族中不同层次的协议](https://github.com/Balabalabalala/Learning/blob/master/images/tcpip/2018-04-16_084642.png)

- TCP和UDP是两种最为著名的运输层协议，二者都使用IP作为网络层协议。虽然TCP使用不可靠的IP服务，但它提供的是一种可靠的运输层服务。UDP为应用程序发送和接收数据报，一个数据报是指从发送方传输到接收方的一个信息单元（如，发送方指定的一定字节数的信息），但是与TCP不同的是，UDP是不可靠的，不能保证数据报安全无误地到达最终目的。

- IP是网络层上的主要协议，同时被TCP和UDP使用。TCP和UDP的每组数据都通过端系统和每个中间路由器中的IP层在互联网中进行传输。应用程序可以直接访问IP，但是很少见。

- ICMP是IP协议的附属协议，IP层用它来与其他主机或路由器交换错误报文和其他重要信息。尽管ICMP主要被IP使用，但是应用程序也能访问它，像Ping和Traceroute都使用了ICMP。

- IGMP是Internet组管理协议，它用来把一个UDP数据报多播到多个主机。

- ARP（地址解析协议）和RARP（逆地址解析协议）是某些网络接口使用的特殊协议，用来转换IP层和网络接口层使用的地址。

## 1.3 互联网的地址
互联网上的每个接口必须有个唯一的Internet地址（IP地址），IP地址长32位。

![五类不同的IP地址](https://github.com/Balabalabalala/Learning/blob/master/images/tcpip/2018-04-17_222653.png)

IP地址具有一定的结构，32位的地址通常写成四个十进制的数，每个整数对应一个字节，这种表示方法称作“点分十进制”。区分各类地址的最简单方式就是看它的第一个十进制整数。
- A类地址范围：0.0.0.0到127.255.255.255
- B类地址范围：128.0.0.0到191.255.255.255
- C类地址范围：192.0.0.0到223.255.255.255
- D类地址范围：224.0.0.0到239.255.255.255
- E类地址范围：240.0.0.0到247.255.255.255

多接口主机具有多个IP地址，其中每个接口都对应一个IP地址。由于互联网上的每个接口必须有一个唯一的IP地址，因此必须要有一个管理机构为接入互联网的网络分配IP地址。这个管理机构就是互联网络信息中心（InterNIC，Internet Network Information Centre）。InterNIC只分配网络号，主机号的分配由系统管理员来负责。NIC负责处理国防数据网的注册请求，其他的Internet用户注册请求均由InterNIC负责处理。InterNIC由注册服务、目录和数据库服务以及信息服务组成。

IP地址有三类：
- 单播地址，目的为单个主机
- 广播地址，目的端为给定网络上的所有主机
- 多播地址，目的端为同一组内的所有主机

## 1.4 域名系统
域名系统DNS是一个分布的数据库，由它来提供IP地址和主机名之间的映射信息。

任何应用程序都可以调用一个标准的库函数来查看给定名字的主机的IP地址，类似的，系统还提供一个逆函数，给定主机的IP地址，查看其所对应的主机名。

## 1.5 封装
当应用程序用TCP传送数据的时候，数据被送入协议栈中，然后逐个通过每一层直到被当作一串比特流送入网络。其中每一层对收到的数据都要增加一些首部信息（有时还要增加尾部信息）。

![数据进入协议栈时的封装过程](https://github.com/Balabalabalala/Learning/blob/master/images/tcpip/2018-04-17_224758.png)

TCP传给IP的数据单元称作TCP报文段或简称（TCP段），IP传给网络接口层的数据单元称作IP数据报，通过以太网传输的比特流称作帧。

以太网数据帧的物理特性是其长度必须在46~1500字节之间。

*octet这个术语表示字节

IP和网络接口层之间传送的数据单元是分组，分组可以是一个IP数据报，也可以是IP数据报的一个片。

UDP数据与TCP数据基本一致，唯一的区别是UDP传给IP的信息单元称作UDP数据报，而且UDP的首部长为8字节。

由于TCP、UDP、ICMP和IGMP都要向IP传送数据，所以IP必须在生成的IP首部中加入某种标识，以表明数据属于哪一层。所以IP在首部中存入一个长度为8bit的数值，称为协议域。1表示ICMP协议i，2表示IGMP协议，6表示TCP协议，17表示UDP协议。

同理，许多应用程序都可以使用TCP或UDP来传送数据，运输层协议在生成报文首部时要存入一个应用程序的标识符。TCP和UDP都用一个16bit的端口号来表示不同的应用程序。TCP和UDP把源端口号和目的端口号分别存入报文首部中。

网络接口分别要发送和接收IP、ARP和RARP数据，因此也必须在以太网的帧首部中加入标识，以指明生成数据的网络层协议，因此以太网的帧首部有一个16bit的帧类型域。

## 分用
当目的主机收到一个以太网数据帧时，数据就从协议栈由底向上升，同时去掉各层协议加上的报文首部。每层协议盒都要检查报文首部中的协议标识，以确定接收数据的上层协议。这个过程称作分用。

![以太网数据帧的分用过程](https://github.com/Balabalabalala/Learning/images/2018-04-17_225857.png)

ICMP和IGMP一方面是IP的附属协议，另一方面，ICMP和IGMP报文都被封装在IP数据报中。

ARP和RARP一方面和IP数据报一样拥有各自的以太网数据帧类型，另一方面ARP又是以太网设备驱动程序的一部分。

















## 参考链接
[1] 令牌环网 https://baike.baidu.com/item/令牌环网/2076446?fr=aladdin
[2] 令牌环 http://218.94.65.67:8028/ebook/4/juyuwan/jy073.htm
